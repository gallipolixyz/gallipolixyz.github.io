# CVE-2025-29927: Next.js Middleware Bypass Zafiyeti

Rachid Allam ve Yasser Allam tarafından keşfedilen ve Next.js'in middleware katmanını tamamen atlatmayı sağlayan kritik bir zafiyetin incelenmesi.

![CVE-2025-29927](/blogs/img/cve-2025-29927-nextjs-middleware-bypass/nextjs-1.png)

Herkese selamlar. Normalde bu konuyu zafiyet ilk çıktığında değerlendirmeliydim ama hayat işte, bir şeyler engel oldu durdu. Neyse, çok uzatmadan zafiyeti incelemeye başlayalım.

CVE-2025-29927 zafiyeti, Next.js'in middleware'ini tamamen atlatmamızı sağlayan bir güvenlik açığıdır. Rachid Allam ve Yasser Allam tarafından keşfedilmiştir ve 9.1'lik kritik bir skora sahip. Sadece bu bilgi bile incelemenin ne kadar önemli olduğunu anlamamızı sağlar.

Zafiyet ve sömürü aşamasına geçmeden önce size bu teknolojilerden bahsetmek isterim. Neyi sömüreceğimizi bilelim ;)

---

## Next.js Nedir?

Next.js bir React framework'üdür. Yani web alanında React'e ek olarak farklı özellikleri bünyesinde barındırır. Web geliştiricileri tarafından sıkça tercih edilmektedir.

## Peki Next.js'teki Bu Middleware Nedir?

Middleware'i bir mekanın kapısındaki güvenlik kontrolü olarak düşünebilirsiniz. Gelen istekleri ilk o karşılar ve üzerlerinde çeşitli değişiklikler yapmamızı sağlar. Web uygulamalarında genellikle kimlik doğrulama, isteği yönlendirme, URL'i yeniden yazma, HTTP başlıklarını düzenleme gibi işlevler görür.

Genellikle projenin ana dizininde veya src dizininde middleware.ts isimli bir dosya olarak oluşturulur. Bu dosyada uygulamanıza uygun konfigürasyonları tanımlayabilirsiniz.

Yavaş yavaş ısınmaya başladık. Artık zafiyet barındıran teknolojinin ne iş yaptığını biliyoruz: Kısaca kapıda istekleri karşılayan ve geliştiricinin istediği şartlara göre aksiyon (yönlendirme, doğrulama vb.) alan bir kod parçası.

---

## Zafiyetli Ortam ve Kod

Ben kendi sitem üzerinde zafiyetli sürümü kurdum ve şimdi beraber inceleyeceğiz. Middleware olarak aşağıdaki kodu yazdım:

```javascript
import { NextResponse } from 'next/server';

export function middleware(request) {
  if (request.nextUrl.pathname.startsWith('/admin')) {
    const authHeader = request.headers.get('Authorization');
    if (authHeader !== 'Bearer my-secret-token') {
      const loginUrl = new URL('/login', request.url);
      return NextResponse.redirect(loginUrl);
    }
  }
  return NextResponse.next();
}
```

Bu, basit bir kimlik doğrulama kodudur. Eğer admin paneline ulaşmaya çalışan kişi "secret token"a sahip değilse, middleware aracılığıyla login sayfasına yönlendirme yapıyor.

![Normal Request](/blogs/img/cve-2025-29927-nextjs-middleware-bypass/nextjs-2.png)

`/admin` sayfasına normal bir istek attığımda response'ta 307 temporary redirect olarak bunu gözlemliyoruz. Bizi `/login` sayfasına yönlendirdi. Gayet güzel çalışıyor...

Gelelim zafiyete. En başta söylediğim üzere bu zafiyette middleware mekanizmasını atlatacağız. Sanıyorum artık zafiyetin ne kadar kritik olduğunu şimdi gözünüzde canlandırabiliyorsunuz.

![Zafiyetli Kod](/blogs/img/cve-2025-29927-nextjs-middleware-bypass/nextjs-3.png)

---

## Zafiyetin Adım Adım Açıklaması

### 1. Saldırgan Kontrolündeki Header (Satır 686–687)

Bu kodda sunucu, gelen isteğin header'ları arasından `x-middleware-subrequest` isimli bir header'ı arar. Normalde bu header, Next.js tarafından bir middleware'in kendi içinde başka bir middleware'i tetiklemesi (rewrite/redirect) durumunda sonsuz döngüleri engellemek için kullanılır. Ancak sunucu, bu header'ın sadece kendi iç mekanizması tarafından mı yoksa dışarıdan bir kullanıcı/saldırgan tarafından mı eklendiğini kontrol etmez.

Saldırgan, atlatmak istediği middleware'in adını bu header'a yazarak sunucuya gönderebilir. Örneğin, `x-middleware-subrequest: middleware` gibi. Kod, bu header'ın değerini `:` karakterinden ayırarak `subrequests` adında bir dizi (array) oluşturur.

### 2. Middleware'in Atlatılması (Satır 707–714)

Sunucu, tanımlı olan her bir middleware'i çalıştırmadan hemen önce bu kontrolü yapar. `middlewareInfo.name`, o an çalıştırılacak olan middleware'in adını içerir (örneğin, dosya yapısına göre `_middleware` veya `auth-middleware` gibi). `if` koşulu, "çalıştırılacak olan middleware'in adı, saldırganın header ile gönderdiği `subrequests` dizisinin içinde var mı?" diye kontrol eder.

Eğer isim dizide varsa, Next.js bu middleware'in zaten daha önce çalıştığını varsayar ve güvenlik katmanını tamamen atlar (`continue` komutuyla bir sonraki adıma geçer). Middleware'in içindeki yetkilendirme, kimlik doğrulama gibi kritik kontroller hiçbir zaman çalıştırılmaz.

Sonuç olarak, `NextResponse.next()` ile istek, sanki middleware kontrolünden başarıyla geçmiş gibi bir sonraki adıma (genellikle korunması gereken sayfanın kendisine) yönlendirilir.

---

## Özetle Saldırı Senaryosu

Bir saldırgan, normalde giriş yapmadan erişemeyeceği `/admin` gibi bir sayfaya erişmek istediğinde:

1. Uygulamanın yetkilendirme için kullandığı middleware'in adını (genellikle `_middleware` veya `middleware`) tahmin eder.
2. İsteğini gönderirken `x-middleware-subrequest: _middleware` header'ını ekler.
3. Next.js sunucusu bu header'ı görür ve `_middleware`'in çalıştırılması gereken adıma geldiğinde, adının `subrequests` dizisinde olduğunu fark eder.
4. Sunucu, "bu middleware zaten çalışmış" diyerek yetkilendirme kodunu atlar ve saldırganı doğrudan `/admin` sayfasına eriştirir.

Middleware dosyası farklı versiyonlarda veya kullanımlarda src klasörünün içerisinde de olabilir. Header'ı yazarken bu duruma göre `src/middleware` olarak da sömürülebilmektedir.

![v15.1.7](/blogs/img/cve-2025-29927-nextjs-middleware-bypass/nextjs-4.png)

---

## Yeni Sürümler İçin Sömürü

Son versiyonlarda kod mantığında ufak değişikliklere gidilmiş. Derinlik değeri `Max_recursion_depth` değerinden büyük veya eşit olmalı yani 5. Bu yüzden header olarak ekleyeceğimiz `x-middleware-subrequest` derinliği de 5 veya daha büyük olmalı. Yani derinlik sayacını yapay olarak artıracağız.

Kullanacağımız header ikisinden biri olmalı:

```
x-middleware-subrequest: middleware:middleware:middleware:middleware:middleware
```

veya

```
x-middleware-subrequest: src/middleware:src/middleware:src/middleware:src/middleware:src/middleware
```

![Admin Access](/blogs/img/cve-2025-29927-nextjs-middleware-bypass/nextjs-5.png)

Ve mutlu son. Admin paneline eriştik.

Ben bu zafiyetli ortamı hazırlarken next.js'in 13.5.6 versiyonunu kullandım ama başka 11.x, 12.x, 13.x, 14.x, 15.x gibi bir çok versiyon bu zafiyetten etkileniyor.

---

## Post-Exploitation: Peki Sonrasında Ne Olacak?

Zafiyetin sonuna geldik ve bu başlı başına çok büyük bir zafiyet. Ama sonuna geldiğimde benim aklıma hemen sonrasında ne olacak sorusu gelmişti. Sizin de gelmiştir. Admin kullanıcı bilgileriyle erişmem gereken yere hiçbir şey yapmadan, bir header girerek erişebildim. Peki kullanıcı adım ne olacak, hangi API neye göre hassas bilgilere, fonksiyonlara erişebileceğim? Kısacası nasıl post-exploitation yapacağım?

Biraz daha Red Team bakış açısıyla yaklaşıyoruz. Bu zafiyeti sömürdükten sonra karşınıza çıkabilecek senaryoları tartışalım.

İlk olarak, büyük ihtimalle admin panelinde API'ler kullanılıyor ve API'lerde yetkilendirme (authorization) token'ı kullanılarak verilere erişilebiliyor. Sizde bu token olmadığına göre herkesin erişebildiği anlamsız tablolar, hata kodları, boş ve karmaşık HTML sayfalarıyla karşılaşmanız çok muhtemel. Burada nasıl ilerlenebilir?

Burada artık admin sayfasındayız. Biz admin sayfasına girdiğimizde arkada hangi API istekleri gidiyor, hangileri 401, 403 dönüyor, hangileri 200 OK dönüyor? Bunları incelememiz gerekiyor. Ve elimizdeki verilerle admin sayfasında yeni zafiyetler kovalamamız gerekiyor. Biraz negatif oldu burası, biraz moralinizi düzelteyim.

Admin sayfaları, normal kullanıcıların eriştiği yerlerden daha az güvenliğine dikkat edilen sayfalar oluyor genelde. Bu yüzden daha rahat zafiyet bulabiliriz ve elimizdeki zafiyetle zincirleyebiliriz. Ya da dediklerim doğru değildir ve her şey, düşük bir ihtimalle de olsa, önünüze serilir. Tamamen arkadaki koda bağlı.

---

## Önlem ve Çözüm (Mitigation)

Evet konunun dışına yeterince çıktık diye düşünüyorum. Şimdi mitigation verip bitiriyorum.

Bu kritik zafiyetten korunmak için atılması gereken adımlar şunlardır:

### Güncelleme (En İyi Yöntem)

Next.js sürümünüzü yamalı versiyonlara yükseltin:
- **14.x kullanıcıları için**: Sürüm 14.2.25 veya üzerine güncelleyin.
- **15.x kullanıcıları için**: Sürüm 15.2.3 veya üzerine güncelleyin.

### Manuel Önlem (Güncelleme Yapamıyorsanız)

Eğer 13.x veya daha eski bir sürüm kullanıyorsanız, uygulamanızın önüne bir katman (örneğin bir WAF veya reverse proxy) koyarak dışarıdan gelen `x-middleware-subrequest` başlığına sahip istekleri tamamen engellemeyi düşünebilirsiniz.

---

## Kapanış

Bir header ile tüm middleware mekanizmasını atlatıp admin paneline erişim almak gerçekten korkutucu. Bu zafiyet sadece bir başlangıç, sonrası tamamen sizin keşif ve sömürü becerinize kalmış.

Umarım bu inceleme hem sömürü hem de savunma tarafında ufkunuzu açmıştır.

İyi araştırmalar!
